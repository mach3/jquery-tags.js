/**
 * Tags.js
 * -------
 * User interface to input tags
 *
 * @version 0.1.0 (2014-09-30)
 * @author mach3 <http://github.com/mach3>
 * @license MIT
 */
!function(a){var b=function(){this.init.apply(this,arguments)};!function(){var c=b.prototype;c.el=null,c.nodeInput=null,c.nodeTags=null,c.nodeHidden=null,c.nodeSuggest=null,c.tags=[],c.suggesting=!1,c.defaults={delimiter:",",nodeTagsContainer:null,tags:null,suggests:null,suggestsLimit:5,classList:"js-tags-list",classLabel:"js-tags-label",classRemove:"js-tags-button-remove",classSuggest:"js-tags-suggest",classSuggestItem:"js-tags-suggest-item"},c.init=function(b,c){this.el=b,this.nodeInput=a(b),this.options={},this.config(this.defaults).config(c),this.initView(),this.initEvents()},c.config=function(b){return a.extend(!0,this.options,b),this},c.initView=function(){var b,c;b=this.options,c=this,this.nodeTags=a("<ul>").addClass(b.classList),b.nodeTagsContainer?b.nodeTagsContainer.append(this.nodeTags):this.nodeTags.insertAfter(this.nodeInput),this.nodeHidden=a("<input>",{type:"hidden",name:this.nodeInput.attr("name")}).insertBefore(this.nodeInput),this.nodeSuggest=a("<div>").addClass(b.classSuggest).css("position","absolute").hide().insertAfter(this.nodeInput),b.tags&&("array"!==a.type(b.tags)&&(b.tags=b.tags.split(b.delimiter)),a.each(b.tags,function(a,b){c.add(b)})),this.nodeInput.attr({name:"",autocomplete:"off"})},c.initEvents=function(){var b,c,d;b=this,c=this.options,d=["onClickRemove","onKeyDown","onBlur","onClickSuggest","onHoverSuggest"],a.each(d,function(c,d){b[d]=a.proxy(b[d],b)}),this.nodeTags.on("click","."+c.classRemove,this.onClickRemove),this.nodeInput.on("keydown",this.onKeyDown),this.nodeSuggest.on("click","."+c.classSuggestItem,this.onClickSuggest),this.nodeSuggest.on("mouseover","."+c.classSuggestItem,this.onHoverSuggest),this.nodeInput.on("blur",this.onBlur)},c.add=function(b){var c,d;c=this.options,d=this,a.each(b.split(c.delimiter),function(b,e){e=a.trim(e),!e||a.inArray(e,d.tags)>=0||(d.tags.push(e),d.nodeHidden.val(d.tags.join(c.delimiter)),a("<li>").append(a("<span>").addClass(c.classLabel).text(e),a("<button>").addClass(c.classRemove).html("&times;")).data("value",e).appendTo(d.nodeTags))})},c.remove=function(b){var c=this.options;b=a.trim(b),this.tags=a.grep(this.tags,function(a){return a!==b}),this.nodeHidden.val(this.tags.join(c.delimiter)),this.nodeTags.find("li").filter(function(){return a(this).data("value")===b}).remove()},c.suggest=function(b){var c,d,e,f,g;return b=void 0===b?!0:!1,c=this.options,d=this.nodeInput.val(),f=this,g=new RegExp(d.split("").join(".*"),"i"),e=a.grep(c.suggests,function(a){return g.test(a)}),b&&""!==d&&e.length?(this.suggesting=!0,e.slice(0,c.suggestLimit),this.nodeSuggest.html(""),a.each(e,function(b,d){a("<div>").addClass(c.classSuggestItem).data("value",d).text(d).appendTo(f.nodeSuggest)}),void this.nodeSuggest.show()):(this.suggesting=!1,void this.nodeSuggest.hide())},c.toggleSuggest=function(a){var b,c,d;a=void 0===a?!0:a,b=this.options,c=this.nodeSuggest.find("."+b.classSuggestItem),d=function(){var a=c.filter(".selected");return a.length?a.prevAll().length:-1}(),d+=a?1:-1,d%=c.length,c.removeClass("selected").eq(d).addClass("selected")},c.cleanSuggest=function(){this.nodeSuggest.find("."+this.options.classSuggestItem).removeClass("selected")},c.selectSuggest=function(){var a,b;return a=this.options,b=this.nodeSuggest.find("."+a.classSuggestItem+".selected"),b.length&&(this.add(b.data("value")),this.nodeInput.val("")),this.suggest(!1),!!b.length},c.onKeyDown=function(a){var b=this;switch(a.which){case 38:if(this.suggesting)return this.toggleSuggest(!1);case 40:if(this.suggesting)return this.toggleSuggest(!0);case 9:if(this.suggesting)return a.preventDefault(),this.toggleSuggest(!a.shiftKey);break;case 13:if(a.preventDefault(),this.suggesting&&this.selectSuggest())return;return this.add(this.nodeInput.val()),this.nodeInput.val(""),void this.suggest(!1);case 16:return;case 27:return b.suggest(!1);default:setTimeout(function(){b.suggest()},10)}},c.onClickRemove=function(b){var c=a(b.currentTarget).closest("li");this.remove(c.data("value"))},c.onBlur=function(){var a=this;this.suggesting&&setTimeout(function(){a.suggest(!1)},100)},c.onClickSuggest=function(b){this.add(a(b.currentTarget).data("value")),this.nodeInput.val("")},c.onHoverSuggest=function(){this.cleanSuggest()}}(),a.fn.tags=function(a){return this.each(function(){this._tagsInstance||(this._tagsInstance=new b(this,a))}),this}}(jQuery);